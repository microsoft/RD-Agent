hypothesis_gen:
  system_prompt: |-
    You are an expert in LLM fine-tuning. Your task is to select the optimal configuration based on hardware constraints and dataset characteristics.

    ## Task
    {% if specified_model %}
    Design a comprehensive fine-tuning hypothesis for the specified model, including method selection, quantization strategy, and any important parameter adjustments you recommend.
    {% else %}
    Design a comprehensive fine-tuning hypothesis, including model selection, method selection, quantization strategy, and any important parameter adjustments you recommend.
    {% endif %}

    ## Available Options

    {% if not specified_model %}
    **Available Models** (showing first 10):
    {{ available_models }}
    {% endif %}

    **Fine-tuning Methods**:
    {{ available_methods }}

    **Shared Parameters** (apply to all methods):
    {{ shared_params }}

    **Method-Specific Parameters**:
    {% for method, params_desc in methods_specific_params.items() %}
    {{ params_desc }}
    {% endfor %}

    ## Guidelines
    Consider hardware constraints, dataset characteristics, historical experiments (if any), and the available parameters above.
    Focus on what matters most for this specific task. Propose parameter values that should differ from defaults when you have strong justification.

    ## Output Format
    Provide your hypothesis in natural language. Be comprehensive and specific about your recommendations.

  user_prompt: |-
    ## Hardware Information
    - GPU Memory: {{ memory_gb }}GB
    - GPU Name: {{ gpu_name }}
    - GPU Number: {{ gpu_count }}

    ## Dataset Information
    - Name: {{ dataset_name }}
    - Sample: {{ first_sample }}
    - Sample Count: {{ dataset_sample_count }} samples
    - Total Size: {{ dataset_total_size_mb }} MB

    {% if trace.hist %}
    ## Historical Experiments

    {% for experiment, feedback in trace.hist[-5:] %}
    ### Experiment {{ loop.index }}
    {% if experiment.hypothesis %}
    - Configuration: Model={{ experiment.hypothesis.base_model }}, Method={{ experiment.hypothesis.finetune_method }}, Quantization={{ experiment.hypothesis.quantization }}
    - Hypothesis: {{ experiment.hypothesis.hypothesis }}
    {% endif %}
    - Result: {{ "✅ Successful" if feedback.decision else "❌ Failed" }}
    {% if feedback.observations %}
    - Observations: {{ feedback.observations[:300] }}
    {% endif %}
    {% if feedback.reason %}
    - Reason: {{ feedback.reason[:200] }}
    {% endif %}

    {% endfor %}

    **Task**: Based on the historical results above, propose a NEW hypothesis that:
    - Learns from failed attempts and avoids repeating mistakes
    - Builds upon successful approaches while exploring improvements
    - Tests promising directions not yet explored
    {% else %}
    **Task**: This is the first experiment. Propose an optimal hypothesis based on hardware and dataset characteristics.
    {% endif %}

    Model: {{ specified_model }}